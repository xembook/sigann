<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">
</head>
<body>
<div class="container">

	<h1>OCR🍅</h1>

	<div id="div1">
		<button type="button" id="restore" class="btn btn-primary">カメラ起動</button>
	</div><!-- div1 -->

	<div class="collapse" id="div3">
		<div id="address"></div>
		<button type="button" id="send_tomato" class="btn btn-primary">送信</button>
		<div id="result">
			<ul></ul>
		</div>
	</div><!-- div3 -->
</div>

<!-- スキャンモーダル -->
<div class="modal fade" id="modal-qrscan" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel2">OCRスキャン</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<label id="modal-label"></label>

				<div class="input-group">
					<label class="input-group-btn mr-1">
						<span class="btn btn-primary">
							画像でスキャン<input id="file_image" type="file" style="display:none">
						</span>
					</label>
				</div>
				<canvas id="canvas"  width="100%" hidden></canvas>
				<!-- canvas id="canvas2"  width="100%"></canvas -->
				<button type="button" id="button_snap" class="btn btn-primary">
					<span id="spinner_snap" class="collapse spinner-border spinner-border-sm" role="status"></span>
					スナップ
				</button>
				<button type="button" id="button_reset" class="btn btn-primary">
					リセット
				</button>
				<div id="scan_data" class="text-break"></div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">キャンセル</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"	id="modal_ok">OK</button>

			</div><!-- /.modal-footer -->
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script type="text/javascript" src="https://unpkg.com/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
	integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
	crossorigin="anonymous">
</script>
<script src="symbol-sdk-pack-1.0.1.js"></script>
<script src="https://xembook.github.io/xembook/xembook_config.js"></script>

<script>



var currentTab;			//カメラ操作している場合の現在選択中のタブ
var scanData = document.getElementById("scan_data");

ocrFrameDiv = 7;
ocrFrameDivTop = (Math.floor(ocrFrameDiv / 2)  )/ ocrFrameDiv;
ocrFrameDivBottom = (Math.floor(ocrFrameDiv / 2)+1) / ocrFrameDiv;

//■■■CONTROLLER■■■
$('#button_reset').prop('disabled', true);

//ログイン
$("#restore").click(function(){

	currentTab = "tab_";
	$('#modal-label').text("アドレスを赤枠内に入れてスキャンしてください。")
	$('#div-ns').collapse('hide');
	$('#modal-qrscan').modal('show');
	startVideo();
});


//スキャンモーダルが閉じられた時
$('#modal-qrscan').on('hide.bs.modal', function (e) {

	stopVideo();
	clearRect();
	$('#file_image').val("");
});

//モーダルウィンドウOKクリック時(モーダル閉じる)
$("#modal_ok").click(async function(){

	if(currentTab == "tab_transfer"){	//送信
	}else if(currentTab == "tab_"){	//復元

		$("#address").text(scanData.innerText);
		$("#div3").show();
		scanData.innerText = "";
	}
});

$('#file_image').change(function(e){scanFileImage("file_image");});
$("#button_snap").click(function(){
	$('#spinner_snap').collapse('show');
	$('#button_snap').prop('disabled', true);

	isMovieScanning = false;

	scale = 2;
	
	canvas2 = document.createElement("canvas");
//	canvas2 = document.getElementById("canvas2");
	canvas2.width=canvasElement.width * scale;
	canvas2.height=canvasElement.height / ocrFrameDiv * scale;

	ctx2 = canvas2.getContext('2d');
	ctx2.drawImage( canvasElement,
		0,canvasElement.height * ocrFrameDivTop ,
		canvasElement.width,canvasElement.height/ ocrFrameDiv ,
		0,0,
		canvasElement.width * scale,canvasElement.height/ocrFrameDiv * scale
	);

	const worker = Tesseract.createWorker();
	(async () => {
		await worker.load();
		await worker.loadLanguage('eng');
		await worker.initialize('eng');
		await worker.setParameters({
			tessedit_char_whitelist: '234567ABCDEFGHIJKLMNOPQRSTUVWXYZ-',
		});
		const { data: { text } } = await worker.recognize(canvas2);

		$('#spinner_snap').collapse('hide');
		var scanedAddress = text.match(/N[0-Z]{5}-*[0-Z]{6}-*[0-Z]{6}-*[0-Z]{6}-*[0-Z]{6}-*[0-Z]{6}-*[0-Z]{2}[AIQY]/);
		
		validAddress = "";
		if(scanedAddress){
			
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[S5]/) ,"S","5");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[Z2]/) ,"Z","2");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[A4]/) ,"A","4");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[E6]/) ,"E","6");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[OD]/) ,"O","D");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[IJ]/) ,"I","J");}
			if(validAddress ==="" ){validAddress = replaceWord( scanedAddress[0].split(/[Z2]/) ,"Z","7");}
			if(validAddress ==="" ){validAddress = replaceWord2(scanedAddress[0].split(/[A4]/) ,"A","4",/[S5]/,"S","5");}
			if(validAddress ==="" ){validAddress = replaceWord2(scanedAddress[0].split(/[IJ]/) ,"I","J",/[S5]/,"S","5");}



			if(validAddress === ""){

				alert("アドレスのスキャンに失敗しました。" + scanedAddress[0]);
				isMovieScanning = true;
				scanData.innerText = "";
				requestAnimationFrame(tick);
				$('#button_snap').prop('disabled', false);
				$('#button_reset').prop('disabled', true);

			}
			console.log(text);
			console.log(scanedAddress);

		}else{
			alert("アドレスのスキャンに失敗しました。");
			isMovieScanning = true;
			scanData.innerText = "";
			requestAnimationFrame(tick);
			$('#button_snap').prop('disabled', false);
			$('#button_reset').prop('disabled', true);

		}


		$('#button_reset').prop('disabled', false);

		await worker.terminate();
	})();
});

function replaceWord(splitedAddress ,a,b){

	let validAddress = "";
	let balls = [...Array(splitedAddress.length ).keys()] ;

	for(let ii=1;ii<balls.length;ii++){
		combi = kumiawase(balls,ii);
		for(let i=0;i<combi.length;i++){

			builder = "";
			for(let j=0;j<splitedAddress.length;j++){
				builder = builder + splitedAddress[j];
				
				if(j !== splitedAddress.length - 1){
					if(combi[i].includes(j)  ){
						builder = builder + a;
					}else{
						builder = builder + b;
					}
				}
			}
			console.log(builder);
			if(nem.Address.isValidRawAddress(builder.replace(/-/g, ''))){
				validAddress = builder;
				scanData.innerText = validAddress;
			}
		}
	}
	console.log(validAddress);
	return validAddress;

}

function replaceWord2(splitedAddress ,a,b,reg,c,d){

	let validAddress = "";
	let balls = [...Array(splitedAddress.length ).keys()] ;

	for(let ii=1;ii<balls.length;ii++){
		let combi = kumiawase(balls,ii);
		for(let i=0;i<combi.length;i++){

			let builder = "";
			for(let j=0;j<splitedAddress.length;j++){
				builder = builder + splitedAddress[j];
				
				if(j !== splitedAddress.length - 1){
					if(combi[i].includes(j)  ){
						builder = builder + a;
					}else{
						builder = builder + b;
					}
				}
			}
			console.log(builder);
			if(validAddress === ""){validAddress = replaceWord( builder.split(reg) ,c,d)}
			console.log(validAddress);
		}
	}
	console.log(validAddress);
	return validAddress;

}

function kumiawase(balls, nukitorisu){
  var arrs, i, j, zensu, kumis;
  arrs = [];
  zensu = balls.length;
  if(zensu < nukitorisu){
    return;
  }else if(nukitorisu == 1){
    for(i = 0; i < zensu; i++){
      arrs[i] = [balls[i]];
    }
  }else{
    for(i = 0; i < zensu - nukitorisu + 1; i ++){
      kumis = kumiawase(balls.slice(i + 1), nukitorisu - 1);
      for(j = 0; j < kumis.length; j ++){
        arrs.push([balls[i]].concat(kumis[j]));
      }
    }
  }
  return arrs;
}

$("#button_reset").click(function(){
	isMovieScanning = true;
	scanData.innerText = "";
	requestAnimationFrame(tick);
	$('#button_snap').prop('disabled', false);
	$('#button_reset').prop('disabled', true);
	$('#spinner_snap').collapse('hide');


});

//スキャン関連///////////////////////////////////

var canvasElement;
var canvas;
var isMovieScanning = false;
var video = document.createElement("video");

function drawLine(begin, end, color) {
	canvas.beginPath();
	canvas.moveTo(begin.x, begin.y);
	canvas.lineTo(end.x, end.y);
	canvas.lineWidth = 4;
	canvas.strokeStyle = color;
	canvas.stroke();
}

function drawFrame(){
	drawLine({x:0,y:canvasElement.height*ocrFrameDivTop}, {x:canvasElement.width,y:canvasElement.height*ocrFrameDivTop},"#FF3B58");
	drawLine({x:canvasElement.width,y:canvasElement.height*ocrFrameDivTop}, {x:canvasElement.width,y:canvasElement.height*ocrFrameDivBottom},"#FF3B58");
	drawLine({x:canvasElement.width,y:canvasElement.height*ocrFrameDivBottom}, {x:0,y:canvasElement.height*ocrFrameDivBottom},"#FF3B58");
	drawLine({x:0,y:canvasElement.height*ocrFrameDivBottom}, {x:0,y:canvasElement.height*ocrFrameDivTop},"#FF3B58");

}
function tick() {
	if(!isMovieScanning){return;}
	if (video.readyState === video.HAVE_ENOUGH_DATA) {
		canvasElement.hidden = false;
		canvasElement.width  = $('.modal-content').width() * 0.9;
		canvasElement.height = $('.modal-content').width() * 0.9 * video.videoHeight / video.videoWidth;

		getCodeInfo(video);
	}
	drawFrame();

	requestAnimationFrame(tick);
}

function getCodeInfo(src){

	canvas.drawImage(src, 0, 0, canvasElement.width, canvasElement.height);
	var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
}

function startVideo(){

	isMovieScanning = true;
	canvasElement = document.getElementById("canvas");
	canvas		  = canvasElement.getContext("2d");

	navigator.mediaDevices.getUserMedia({
		video: {
			facingMode: "environment"
		}
	})
	.then(function(stream) {
		video.srcObject = stream;
		window.localStream = stream;
		video.setAttribute("playsinline", true);
		video.play();
		requestAnimationFrame(tick);

	});
}

function stopVideo(){
	if(window.localStream != undefined){
		window.localStream.getTracks().forEach( (track) => {
			track.stop();
		});
	}
}

function clearRect(){

	canvas.clearRect(0, 0, canvasElement.width, canvasElement.height);
}
//ファイル処理関連///////////////////////////////

function scanFileImage(tag){

	isMovieScanning = false;
	canvasElement.hidden = false;

	stopVideo();
	const fileList = document.getElementById(tag).files;
	const reader = new FileReader();
	const file = fileList[0];
	if (file.type == 'image/jpeg' || file.type == 'image/png'){
		reader.readAsDataURL(file, "utf-8");
		reader.onload = (function(_) {
			return function(e) {

				const img = new Image();
				img.src = e.target.result;
				img.onload = function() {
					canvasElement.width  = $('.modal-content').width() * 0.9;
					canvasElement.height = $('.modal-content').width() * 0.9 * img.height / img.width;
					getCodeInfo(img);
					drawFrame();
				};
			};
		})(file);
	} else {
		alert('JPEGかPNGファイルをアップして下さい');
	}
}
////////////////////////////////////////////////////////

const nem = require("/node_modules/symbol-sdk");
const op = require("/node_modules/rxjs/operators");
const rxjs = require("/node_modules/rxjs");

const node = "https://node.xembook.net";
const repo = new nem.RepositoryFactoryHttp(node);
const txRepo = repo.createTransactionRepository();
const nsRepo = repo.createNamespaceRepository();
var listener;

(async() =>{
	if(listener === undefined){
		const wsEndpoint = node.replace('http', 'ws') + "/ws";
		await listenerKeepOpening(wsEndpoint,repo.createNamespaceRepository());
	}

	async function listenerKeepOpening(wsEndpoint,nsRepo){

		listener = new nem.Listener(wsEndpoint,nsRepo,WebSocket);
		await listener.open();
		console.log("listener open");
		listener.webSocket.onclose = async function(){
			console.log("listener onclose");
			await listenerKeepOpening(wsEndpoint,nsRepo);
		}
	}
})();

$("#send_tomato").click(function(){
	privateKey = "";
	alice = nem.Account.createFromPrivateKey(privateKey, nem.NetworkType.MAIN_NET);
	
//	address = $("#address").text();
	address = nem.Address.createFromRawAddress("ND7MNBG4RYJX5BBHQ2AB5ZVQSWDHKUOUJQB7WVI");

	tx = nem.TransferTransaction.create(
		nem.Deadline.create(1615853185),
		address, 
		[new nem.Mosaic(new nem.MosaicId('310378C18A140D1B'), nem.UInt64.fromUint(1))],
		nem.PlainMessage.create('Happy NEM Tomatina!'),
		nem.NetworkType.MAIN_NET
	).setMaxFee(100);
	
	signedTx = alice.sign(tx,"57F7DA205008026C776CB6AED843393F04CD458E0AA2D9F1D5F31A402072B2D6");
	console.log(signedTx.hash);
	txRepo.announce(signedTx).subscribe(x=>{

		$('#result ul')
		.append('<li><a target="_blank" href="http://explorer.symbolblockchain.io/transactions/' + signedTx.hash + '">エクスプローラーで確認</a></li>');

		console.log(x)
	});
});

</script>
</body>
</html>
