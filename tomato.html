<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
<link rel="stylesheet"
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
	crossorigin="anonymous">
</head>
<body>
<div class="container">

	<h1>SigAnnğŸ…</h1>

	<div class="collapse" id="div1">
		<label>ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º:</label>
		<input type="text" id="pass" class="form-control">
		<div id="div_use_saved_qr" class="form-group form-check">
	       <input type="checkbox" class="form-check-input" id="use_saved_qr">
	       <label class="form-check-label" for="use_saved_qr">ç«¯æœ«ã®ä¿å­˜æƒ…å ±ã§ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹</label>
	    </div>

		<button type="button" id="create" class="btn btn-primary">æ–°è¦ä½œæˆ</button>
		<button type="button" id="restore" class="btn btn-primary">ãƒ­ã‚°ã‚¤ãƒ³</button>
	</div><!-- div1 -->

	<div class="collapse" id="div3">
		<hr>
		<ul class="nav nav-tabs">
			<li class="nav-item"><a href="#tab_contact"  data-toggle="tab" class="nav-link active">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</a></li>
			<li class="nav-item"><a href="#tab_transfer" data-toggle="tab" class="nav-link" id="tab_transfer_link">èª­ã¿å–ã‚Š</a></li>
			<li class="nav-item"><a href="#tab_setting"  data-toggle="tab" class="nav-link">è¨­å®š</a></li>
		</ul>
		<div class="tab-content">
			<div id="tab_contact" class="tab-pane active"><!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ -->
				<br>
				<div class="card" style="width: 18rem;">
					<img class="card-img-top" id="qr_contact" alt="ã‚«ãƒ¼ãƒ‰ã®ç”»åƒ">
					<div class="card-body">
						<h5 class="card-title">ã‚¢ãƒ‰ãƒ¬ã‚¹</h5>
						<p class="card-text" id="text_contact"></p>
						<div>
							<dl id="account_info"></dl>

					        <div class="collapse" id="spinner_faucet">
					            <div id="wait2" class="spinner-border text-primary" role="status">
					              <span class="sr-only">æ‰¿èªä¸­...</span>
					            </div>
					        </div>
						</div>


						<div>
							<button type="button" id="button_faucet" class="btn btn-primary">
								Faucet
							</button>
						</div>
					</div>
				</div>
			</div>
			<div id="tab_transfer" class="tab-pane"><!-- é€ä¿¡ -->
				<br>
				<dl id="transfer_info"></dl>

				<div>
					<button type="button" id="button_transfer" class="btn btn-primary">
						<span id="spinner_transfer" class="collapse spinner-border spinner-border-sm" role="status"></span>
						ç½²åï¼†é€ä¿¡
					</button>
				</div>
				<div id="confirmed_transfer">
					<ul></ul>
				</div>
			</div>

			<div id="tab_setting" class="tab-pane"><!-- è¨­å®š -->
				<br>
				<div>
					<button type="button" id="button_save" class="btn btn-primary">
						ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¿å­˜
					</button>
					<button type="button" id="button_change_pass" class="btn btn-primary">
						ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå¤‰æ›´
					</button>
					<button type="button" id="button_qr" class="btn btn-primary">
						éµæƒ…å ±è¡¨ç¤º
					</button>
				</div>
				<br>
				<div class="collapse" id="div-setting">
					<div class="card" style="width: 18rem;">
						<img class="card-img-top" id="qr_account" alt="ã‚«ãƒ¼ãƒ‰ã®ç”»åƒ">
						<div class="card-body">
							<p class="card-text bg-danger text-white" >éµæƒ…å ±ã‚’æ§ãˆãŸå¾Œã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„</p>
							<h5 class="card-title">ç§˜å¯†éµ</h5>
							<p class="card-text" id="qr_key"></p>
						</div>
					</div>
				</div>
			</div>
		</div><!-- tab-content -->
	</div><!-- div3 -->
</div>

<!-- QRã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal-qrscan" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel2">QRã‚¹ã‚­ãƒ£ãƒ³</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<label id="modal-label"></label>

				<div class="input-group">
					<label class="input-group-btn mr-1">
						<span class="btn btn-primary">
							ç”»åƒã§ã‚¹ã‚­ãƒ£ãƒ³<input id="file_image" type="file" style="display:none">
						</span>
					</label>
				</div>
				<canvas id="canvas"  width="100%" hidden></canvas>
				<div id="scan_data" class="text-break"></div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal"	id="modal_ok">OK</button>

			</div><!-- /.modal-footer -->
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="modal-msig" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">ãƒãƒ«ãƒã‚·ã‚°é¸æŠ</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="é–‰ã˜ã‚‹">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="list-msig" class="list-group text-break" style="max-width: 400px;"><ul></ul></div>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
	integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
	crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
<script src="jsQR.js"></script>

<script src="symbol-sdk-pack-1.0.1.js"></script>
<script src="xembook_config.js"></script>
<script>
var nodelist = NODES;
var explorer = EXPLORER;
//const nodelist = TEST_NODES;
//const explorer = TEST_EXPLORER;
const FAUCET   = 'http://faucet.testnet.symboldev.network';

</script>
<script src="xembook-core.js"></script>
<script>
const qr   = require("/node_modules/symbol-qr-library");
var payload ="";

startApp(
	//åˆæœŸè¨­å®šå®Œäº†å¾Œ
	function(){

		listener.newBlock();

		if (1 < document.location.search.length) {

			const query = document.location.search.substring(1);
			const prms = query.split('&');
			const item = new Object();
			for (var i = 0; i < prms.length; i++) {
				const elm   = prms[i].split('=');
				const idx   = decodeURIComponent(elm[0]);
				const val   = decodeURIComponent(elm[1]);
				item[idx] = decodeURIComponent(val);
			}
			if("payload" in item){ payload = item["payload"];}
		}

		if(localStorage.getItem('signerJSON') == null){

			$('#use_saved_qr').prop('checked', false);

		}else{

			$('#div_use_saved_qr').collapse('show');
			$('#use_saved_qr').prop('checked', true);
		}

		$('#div1').collapse('show');

	},
	//ãƒªã‚¹ãƒŠãƒ¼å†èµ·å‹•å¾Œ
	function(){
		listener.newBlock();
		if(assetPublicAccount !== undefined){
			showAccountQR();
		}
	},
	//ãƒªã‚¹ãƒŠãƒ¼å—ä¿¡å¾Œ
	async function(txs){

		alert("ç½²åå¾…ã¡ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ã€‚")

		disableScan = true;
		$("#transfer_info").empty();
		$("#tab_transfer_link").click();

		for(const tx of txs){
			await appendTxInfo(tx,tx.signer.address);
		}
	},
	//ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†å¾Œ
	function(data){

		scanData.innerText = data;
	}
);

//ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var assetPublicAccount;	//æ“ä½œå¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒãƒ«ãƒã‚·ã‚°ã®å ´åˆã¯æ“ä½œã•ã‚Œã‚‹å¯¾è±¡ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
var signerJSON;			//æš—å·åŒ–æ¸ˆã¿ç½²åè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

var disableScan = false;
var currentTab;			//ã‚«ãƒ¡ãƒ©æ“ä½œã—ã¦ã„ã‚‹å ´åˆã®ç¾åœ¨é¸æŠä¸­ã®ã‚¿ãƒ–
var scanData = document.getElementById("scan_data");


async function appendTxInfo(tx,senderAddress){

	var dtTx = "<dt>" + nem.TransactionType[tx.type] + "</dt>";
	var ddTx = "<dd>é€ä¿¡è€…:" + senderAddress.pretty().slice(0,14) + "..." + senderAddress.pretty().slice(-3) + "</dd>";
	switch (nem.TransactionType[tx.type]) {
		case "TRANSFER":
			ddTx += "<dd>â†’å—ä¿¡è€…:" + tx.recipientAddress.pretty().slice(0,14) + "..." + tx.recipientAddress.pretty().slice(-3)  + "</dd>";

			for(var item of tx.mosaics){

				const mosaic = await getMosaicAsset(item.id);
				ddTx += "<dd>ã€€[" + mosaic.label + ":" + dispAmount(item.amount.toString(),mosaic.info.divisibility) + "]</dd>";
			}

			break;
		case "MULTISIG_ACCOUNT_MODIFICATION":	break;
		case "ACCOUNT_METADATA":	break;
		case "NAMESPACE_METADATA":	break;
		case "NAMESPACE_REGISTRATION":	break;
		case "HASH_LOCK":	break;
		case "SECRET_LOCK":	break;
		case "SECRET_PROOF":	break;
		case "MOSAIC_METADATA":	break;
		case "MOSAIC_DEFINITION":	break;
		case "MOSAIC_SUPPLY_CHANGE":	break;
		case "MOSAIC_ALIAS":	break;
		case "ADDRESS_ALIAS":	break;
		case "MOSAIC_GLOBAL_RESTRICTION":	break;
		case "MOSAIC_ADDRESS_RESTRICTION":	break;
		case "ACCOUNT_MOSAIC_RESTRICTION":	break;
		case "ACCOUNT_ADDRESS_RESTRICTION":	break;
		case "ACCOUNT_OPERATION_RESTRICTION":	break;
		case "VOTING_KEY_LINK":	break;
		case "VRF_KEY_LINK":	break;
		case "NODE_KEY_LINK":	break;
		case "ACCOUNT_KEY_LINK":	break;
//		case "AGGREGATE_COMPLETE":	break;
//		case "AGGREGATE_BONDED":	break;

		default:
			console.log(nem.TransactionType[tx.type]);
	}

	$("#transfer_info").append(dtTx + ddTx);
}

async function showPayload(){

	if(payload !== ""){

		var aggTx = nem.TransactionMapping.createFromPayload(payload);
		qrcode = qr.QRCodeGenerator.createTransactionRequest(aggTx,networkType,generationHash);
		scanData.innerText = qrcode.toJSON();

		alert("URLã«åŸ‹ã‚è¾¼ã¾ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒã—ã¾ã™ã€‚")

		disableScan = true;
		$("#transfer_info").empty();
		$("#tab_transfer_link").click();

		await showTxInfo(aggTx);
	}
}

function getTxFromScanData(tx){
	var qrcode = qr.QRCodeGenerator.createTransactionRequest(tx,networkType,generationHash);
	scanData.innerText = qrcode.toJSON();
	return qr.TransactionQR.fromJSON(scanData.innerText,nem.TransactionMapping.createFromPayload).transaction;

}

async function showTxInfo(aggTx){

	if("innerTransactions" in aggTx){

		for(i = 0 ; i < aggTx.innerTransactions.length; i++){

			if(aggTx.innerTransactions[i].signer.address.plain() === "TAXQUTQQNS6JEJG7PLC6FRVJ2USS44GLMVULPGQ"){

				aggTx.innerTransactions[i].signer = assetPublicAccount;
			}
		}

		//è‡ªåˆ†ã®ç½²åãŒå¿…è¦ãªã„ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ãƒ€ãƒŸãƒ¼ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
		if(aggTx.innerTransactions.find(inTx => inTx.signer.equals(assetPublicAccount)) === undefined){
			dummyTx = nem.TransferTransaction.create(
			    undefined,
			    assetPublicAccount.address,
			    [],
			    nem.EmptyMessage,
			    networkType
			);
			aggTx.innerTransactions.push(dummyTx.toAggregate(assetPublicAccount));
		}

		qrcode = qr.QRCodeGenerator.createTransactionRequest(aggTx,networkType,generationHash);
		scanData.innerText = qrcode.toJSON();
		aggTx = qr.TransactionQR.fromJSON(scanData.innerText,nem.TransactionMapping.createFromPayload).transaction;

		//ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
		for(const tx of aggTx.innerTransactions){
			await appendTxInfo(tx,tx.signer.address);
		}
	}else{

		//é€ä¿¡è€…undefinedã®å ´åˆã¯
		if(aggTx.signer === undefined){

			aggTx.signer = assetPublicAccount;
		}

		qrcode = qr.QRCodeGenerator.createTransactionRequest(aggTx,networkType,generationHash);
		scanData.innerText = qrcode.toJSON();
		aggTx = qr.TransactionQR.fromJSON(scanData.innerText,nem.TransactionMapping.createFromPayload).transaction;

		await appendTxInfo(aggTx,assetPublicAccount.address);
	}

}

function showAccountQR(){

	//subscribeå®Ÿè£…
	const subscribeAccountInfo = async function(mosaics){

		$("#account_info").empty();
		for(var i of mosaics){

			console.log(i.id.toHex());
			var mosaic = await getMosaicAsset(i.id);

			$("#account_info").append("<dt>[" + mosaic.label + "]</dt><dd>" + dispAmount(i.amount.toString(),mosaic.info.divisibility) + "</dd>");
		}

		$('#spinner_faucet').collapse('hide');
		$('#button_faucet').prop('disabled', false);

	}

	setAccountObserver(assetPublicAccount.address,subscribeAccountInfo);
	setSignerListener(assetPublicAccount.address);


	//æœªæ‰¿èªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å—ä¿¡ï¼ˆã‚¹ãƒ”ãƒŠãƒ¼å›ã™ï¼‰
	//TODO: ã‚¢ã‚°ãƒªã‚²ãƒ¼ãƒˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æœªå¯¾å¿œ
	console.log("listener set:"+ assetPublicAccount.address.plain());
	listener.unconfirmedAdded(assetPublicAccount.address)
	.pipe(
		op.filter((tx) => tx.mosaics !== undefined),
		op.mergeMap(_=>{
			console.log(_);
			return _.mosaics;
		}),
		op.filter(_ => _.id.toHex() === currencyId || _.id.toHex() === currencyNamespaceId)
	)
	.subscribe(_=> {
		console.log("unconfirmed")
		$('#spinner_faucet').collapse('show')
	},err => console.error(err));


	const contactQR = new qr.ContactQR("xempage.contact.1",assetPublicAccount);
	contactQR.toBase64().subscribe(x => {
		$('#qr_contact').attr('src',x);
		$('#text_contact').text(assetPublicAccount.address.plain());

		$('#div3').collapse('show');
	});


}

function showConfirmedTx(address,hash){
	signedTxConfirmed(address,hash)
	.subscribe(_=> {
		$('#confirmed_transfer ul')
		.append('<li><a target="_blank" href="' + explorer + '/transactions/' + hash + '">ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ã§ç¢ºèª</a></li>');

	},err => {
		alert(err);
		console.error(err);
	}).add(() => $('#spinner_transfer').collapse('hide'));
}


//â– â– â– CONTROLLERâ– â– â– 

//ãƒ­ã‚°ã‚¤ãƒ³
$("#restore").click(function(){

	if($("#use_saved_qr:checked").val()){

		restoreAccount(localStorage.getItem('signerJSON'));

	}else{
		currentTab = "tab_";
		$('#modal-label').text("QRã‚³ãƒ¼ãƒ‰[ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ]ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚")
		$('#div-ns').collapse('hide');
		$('#modal-qrscan').modal('show');
		startVideo();
	}
});

//ã‚¿ãƒ–é¸æŠæ™‚
$(".nav-item a").click( function(e){

	if( this.href.indexOf("tab_transfer") > 0 && !disableScan){
		currentTab = "tab_transfer";
		$('#div-ns').collapse('show');
		$('#modal-label').text("QRã‚³ãƒ¼ãƒ‰[ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³]ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚")
		$('#modal-qrscan').modal('show');
		startVideo();

	}else{
		stopVideo();
		disableScan = false;
	}
});

//ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚
$('#modal-qrscan').on('hide.bs.modal', function (e) {

	stopVideo();
	clearRect();
	$('#file_image').val("");
});

//ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦OKã‚¯ãƒªãƒƒã‚¯æ™‚(ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹)
$("#modal_ok").click(async function(){

	if(currentTab == "tab_transfer"){	//é€ä¿¡

		$("#transfer_info").empty();
		aggTx = qr.TransactionQR.fromJSON(scanData.innerText,nem.TransactionMapping.createFromPayload).transaction;

//		payloadType = nem.TransactionType[aggTx.type];

		await showTxInfo(aggTx);


	}else if(currentTab == "tab_"){	//å¾©å…ƒ

		//ã‚¹ã‚­ãƒ£ãƒ³ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸå ´åˆ
		restoreAccount(scanData.innerText);
		scanData.innerText = "";
	}
});

function restoreAccount(textQR){

	try{
		const signerQR = qr.AccountQR.fromJSON(textQR,$("#pass").val());
		assetPublicAccount = (
			nem.Account.createFromPrivateKey(signerQR.accountPrivateKey,networkType)
		).publicAccount;

		signerQR.toBase64().subscribe(x => {
			$('#div1').collapse('hide');
			$('#div2').collapse('show');
		});
		signerJSON = signerQR.toJSON();
		delete signerQR;
	}
	catch (e) {
		alert("ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
		console.log(e);
		return false;
	}

	const appendList = function(publicKey,name){
		$('#list-msig ul')
		.append('<button type="button" publicKey="'
		+ publicKey
		+'" data-toggle="msig" class="button-msig list-group-item list-group-item-action">'
		+ name
		+ '</button>'
		);
	};

	//ãƒãƒ«ãƒã‚·ã‚°ä¿æœ‰èª¿æŸ»
	msigRepo.getMultisigAccountInfo(assetPublicAccount.address)
	.subscribe(async function(_){

		//ãƒãƒ«ãƒã‚·ã‚°ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
		if(_.multisigAddresses.length > 0){

			appendList(assetPublicAccount.publicKey,"ãƒ¡ã‚¤ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ");
			accountRepo.getAccountsInfo(_.multisigAddresses)
			.subscribe(items => {

				for (item of items) {
					appendList(item.publicKey,item.address.plain());
				}
			})

			//ãƒãƒ«ãƒã‚·ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
			$('#modal-msig').modal('show');

		}else{

			if(_.cosignatories.length > 0){
				alert("ãƒãƒ«ãƒã‚·ã‚°åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€æ“ä½œã§ãã¾ã›ã‚“ã€‚");
			}
			showAccountQR();
			await showPayload();
		}
	},
	async function(err){

		//ãƒãƒ«ãƒã‚·ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆ
		if(err.toString().indexOf("ResourceNotFound")  > 0){
			showAccountQR();
			await showPayload();
		}else{
			alert(err);
		}
	});
}

//ãƒãƒ«ãƒã‚·ã‚°é¸æŠ
$("#list-msig").on("click",".button-msig", async function() {

	$('#modal-msig').modal('hide');
	assetPublicAccount = nem.PublicAccount.createFromPublicKey($(this).attr("publicKey"),networkType);
	showAccountQR();
	await showPayload();

});

//æ–°è¦ä½œæˆ
$("#create").click(async function(){

	const asset = nem.Account.generateNewAccount(networkType);
	console.log(asset);
	assetPublicAccount = asset.publicAccount;
	setSignerListener(assetPublicAccount.address);

	const signerQR = qr.QRCodeGenerator.createExportAccount(asset.privateKey, networkType, generationHash, $("#pass").val())

	signerQR.toBase64().subscribe(x =>{
		showAccountQR();
		$('#div1').collapse('hide');
		$('#div3').collapse('show');
	});
	signerJSON = signerQR.toJSON();

	var msg = "ä½œæˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ";
	if(localStorage.getItem('signerJSON') !== null){
		msg += "\nä»¥å‰ã«ä¿å­˜ã—ã¦ã„ãŸæƒ…å ±ã¯ä¸Šæ›¸ãå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã§ä»Šå›ä½œæˆã—ãŸã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä¸€æ™‚çš„ã«ä½¿ç”¨ã—ã¾ã™ã€‚";
	}

	if(window.confirm(msg)){
		localStorage.setItem('signerJSON',signerJSON);
	}

	await showPayload();
	delete asset;
	delete signerQR;
});

$('#file_image').change(function(e){scanFileImage("file_image");});

/** èª­ã¿è¾¼ã¿ã‚¿ãƒ– **/

$("#button_transfer").click(
	function(){

		const signerQR = qr.AccountQR.fromJSON(signerJSON,window.prompt("ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", ""));
		const signer = nem.Account.createFromPrivateKey(signerQR.accountPrivateKey,networkType);
		delete signerQR;

		$('#spinner_transfer').collapse('show');

		try {
//			const jsonData = JSON.parse(scanData.innerText).data;
			const tx = qr.TransactionQR.fromJSON(scanData.innerText,nem.TransactionMapping.createFromPayload).transaction;

			if(nem.TransactionType[tx.type] === "AGGREGATE_BONDED"){
				exeAggBondedTx(signer,tx);
			}else{
				exeTransfer(signer,tx);
			}

		} catch (e) {

			if(scanData.innerText.length === 64){

				//64ãƒã‚¤ãƒˆã®å ´åˆã¯éƒ¨åˆ†ç½²åã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨åˆ¤æ–­
				exeCosignature(signer,scanData.innerText);

			}else{

				//payloadãƒ‡ãƒ¼ã‚¿ã¨åˆ¤æ–­
				const tx = nem.TransactionMapping.createFromPayload(scanData.innerText);

				if(nem.TransactionType[tx.type] === "AGGREGATE_BONDED"){
					exeAggBondedTx(signer,tx);
				}else{
					exeTransfer(signer,tx);
				}
			}
		}

		delete signer;

		//ã‚¹ã‚­ãƒ£ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ç„¡åŠ¹ã®çµ‚äº†
		disableScan = false;
	}
);
$("#button_faucet").click(function(){

		$('#button_faucet').prop('disabled', true);

		$.ajax({
			url: "https://ec2.xembook.net/tomato/" + assetPublicAccount.address.plain()  ,
			type: 'GET',
			error: function(XMLHttpRequest) {
				console.log( XMLHttpRequest);
				$('#button_faucet').prop('disabled', false);

			}
		}).done(function(res){
			console.log(res);
		});
});

/** è¨­å®šã‚¿ãƒ– **/

//éµæƒ…å ±è¡¨ç¤º
$("#button_qr").click(function(){

	try{

		const signerQR = qr.AccountQR.fromJSON(signerJSON,window.prompt("ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", ""));
		signerQR.toBase64().subscribe(x =>{
			$('#qr_account').attr('src',x);
			$('#qr_key').text(signerQR.accountPrivateKey);
			$('#div-setting').collapse('show');
		});
		delete signerQR;
	}
	catch (e) {
		alert("ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒç•°ãªã‚Šã¾ã™ã€‚");
		console.log(e);
		return false;
	}
});

//ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¿å­˜
$("#button_save").click(function(){

	var msg = "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ä¿å­˜ã—ã¾ã™ã€‚";
	if(localStorage.getItem('signerJSON') !== null){
		msg += "\nä»¥å‰ã«ä¿å­˜ã—ã¦ã„ãŸæƒ…å ±ã¯ä¸Šæ›¸ãå‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
	}

	if(window.confirm(msg)){
		localStorage.setItem('signerJSON',signerJSON);
	}
});

//ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºå¤‰æ›´
$("#button_change_pass").click(function(){

	try{

		const oldSignerQR = qr.AccountQR.fromJSON(signerJSON,window.prompt("ç¾åœ¨ã®ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", ""));
		const signerQR = qr.QRCodeGenerator.createExportAccount(
			oldSignerQR.accountPrivateKey,
			networkType,
			generationHash,
			window.prompt("æ–°ã—ã„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚", "")
		);

		var msg = "å¤‰æ›´ã—ã¾ã—ãŸã€‚ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ã‚’ç«¯æœ«ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ";
		if(localStorage.getItem('signerJSON') !== null){
			msg += "\nå¤ã„ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºæƒ…å ±ã¯ä¸Šæ›¸ãå‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
		}

		signerJSON = signerQR.toJSON();
		if(window.confirm(msg)){
			localStorage.setItem('signerJSON',signerJSON);
		}

		delete signerQR;
		delete oldSignerQR;
	}
	catch (e) {
		alert("ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒç•°ãªã‚Šã¾ã™ã€‚");
		console.log(e);
		return false;
	}
});

</script>
</body>
</html>
